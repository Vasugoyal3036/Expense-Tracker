{% extends 'layout.html' %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="dashboard">
    <!-- Header Section -->
    <header class="dashboard-header">
        <div class="header-content">
            <h1 class="page-title">
                <span class="greeting">Welcome back,</span>
                <span class="username">{{ session.get('username', 'User') }}!</span>
            </h1>
            <p class="subtitle">Here's your financial overview</p>
        </div>
        <button class="btn btn-primary btn-glow" onclick="openModal('addExpenseModal')">
            <i class="fas fa-plus"></i>
            Add Expense
        </button>
    </header>

    <!-- Stats Cards -->
    <section class="stats-grid">
        <div class="stat-card stat-total animate-on-scroll">
            <div class="stat-icon">
                <i class="fas fa-chart-line"></i>
            </div>
            <div class="stat-info">
                <span class="stat-label">Total Expenses</span>
                <span class="stat-value">{{ format_currency(stats.total) }}</span>
            </div>
            <div class="stat-decoration"></div>
        </div>

        <div class="stat-card stat-monthly animate-on-scroll">
            <div class="stat-icon">
                <i class="fas fa-calendar-alt"></i>
            </div>
            <div class="stat-info">
                <span class="stat-label">This Month</span>
                <span class="stat-value">{{ format_currency(stats.monthly) }}</span>
            </div>
            <div class="stat-decoration"></div>
        </div>

        <div class="stat-card stat-weekly animate-on-scroll">
            <div class="stat-icon">
                <i class="fas fa-calendar-week"></i>
            </div>
            <div class="stat-info">
                <span class="stat-label">This Week</span>
                <span class="stat-value">{{ format_currency(stats.weekly) }}</span>
            </div>
            <div class="stat-decoration"></div>
        </div>

        <div class="stat-card stat-avg animate-on-scroll">
            <div class="stat-icon">
                <i class="fas fa-calculator"></i>
            </div>
            <div class="stat-info">
                <span class="stat-label">Avg. Transaction</span>
                <span class="stat-value">{{ format_currency(stats.average) }}</span>
            </div>
            <div class="stat-decoration"></div>
        </div>
    </section>

    <!-- Charts Section -->
    <section class="charts-section">
        <div class="chart-card animate-on-scroll">
            <h3 class="chart-title">
                <i class="fas fa-chart-bar"></i>
                Monthly Spending
            </h3>
            <div class="chart-container">
                <canvas id="monthlyChart"></canvas>
            </div>
        </div>

        <div class="chart-card animate-on-scroll">
            <h3 class="chart-title">
                <i class="fas fa-chart-pie"></i>
                Spending by Category
            </h3>
            <div class="chart-container">
                <canvas id="categoryChart"></canvas>
            </div>
        </div>
    </section>

    <!-- Expenses Table -->
    <section class="expenses-section animate-on-scroll">
        <div class="section-header">
            <h2 class="section-title">
                <i class="fas fa-list-ul"></i>
                Recent Transactions
            </h2>
            <span class="transaction-count">{{ stats.transaction_count }} transactions</span>
        </div>

        {% if expenses %}
        <div class="expenses-table-container">
            <table class="expenses-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Description</th>
                        <th>Category</th>
                        <th>Amount</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for expense in expenses %}
                    <tr class="expense-row" data-id="{{ expense['id'] }}">
                        <td class="expense-date">
                            <i class="fas fa-calendar"></i>
                            {{ expense['date'] }}
                        </td>
                        <td class="expense-description">{{ expense['description'] }}</td>
                        <td class="expense-category">
                            <span
                                class="category-badge category-{{ expense['category']|lower|replace(' ', '-')|replace('&', '') }}">
                                {{ expense['category'] }}
                            </span>
                        </td>
                        <td class="expense-amount">{{ format_currency(expense['amount']) }}</td>
                        <td class="expense-actions">
                            <button class="btn-icon btn-edit"
                                onclick="openEditModal({{ expense['id'] }}, '{{ expense['description'] }}', {{ expense['amount'] }}, '{{ expense['category'] }}', '{{ expense['date'] }}')"
                                title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <form action="{{ url_for('delete_expense', expense_id=expense['id']) }}" method="POST"
                                class="inline-form"
                                onsubmit="return confirm('Are you sure you want to delete this expense?')">
                                <button type="submit" class="btn-icon btn-delete" title="Delete">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="empty-state">
            <div class="empty-icon">
                <i class="fas fa-receipt"></i>
            </div>
            <h3>No expenses yet</h3>
            <p>Start tracking your spending by adding your first expense!</p>
            <button class="btn btn-primary" onclick="openModal('addExpenseModal')">
                <i class="fas fa-plus"></i>
                Add Your First Expense
            </button>
        </div>
        {% endif %}
    </section>
</div>

<!-- Add Expense Modal -->
<div id="addExpenseModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fas fa-plus-circle"></i> Add New Expense</h2>
            <button class="modal-close" onclick="closeModal('addExpenseModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form action="{{ url_for('add_expense') }}" method="POST" class="expense-form">
            <div class="form-group">
                <label for="description">
                    <i class="fas fa-pen"></i>
                    Description
                </label>
                <input type="text" id="description" name="description" placeholder="What did you spend on?" required>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="amount">
                        <i class="fas fa-dollar-sign"></i>
                        Amount
                    </label>
                    <input type="number" id="amount" name="amount" step="0.01" min="0.01" placeholder="0.00" required>
                </div>
                <div class="form-group">
                    <label for="date">
                        <i class="fas fa-calendar"></i>
                        Date
                    </label>
                    <input type="date" id="date" name="date" required>
                </div>
            </div>
            <div class="form-group">
                <label for="category">
                    <i class="fas fa-tag"></i>
                    Category
                </label>
                <select id="category" name="category" required>
                    <option value="">Select a category</option>
                    {% for cat in categories %}
                    <option value="{{ cat }}">{{ cat }}</option>
                    {% endfor %}
                </select>
            </div>
            <button type="submit" class="btn btn-primary btn-block">
                <i class="fas fa-check"></i>
                Add Expense
            </button>
        </form>
    </div>
</div>

<!-- Edit Expense Modal -->
<div id="editExpenseModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fas fa-edit"></i> Edit Expense</h2>
            <button class="modal-close" onclick="closeModal('editExpenseModal')">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="editExpenseForm" method="POST" class="expense-form">
            <div class="form-group">
                <label for="edit_description">
                    <i class="fas fa-pen"></i>
                    Description
                </label>
                <input type="text" id="edit_description" name="description" placeholder="What did you spend on?"
                    required>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="edit_amount">
                        <i class="fas fa-dollar-sign"></i>
                        Amount
                    </label>
                    <input type="number" id="edit_amount" name="amount" step="0.01" min="0.01" placeholder="0.00"
                        required>
                </div>
                <div class="form-group">
                    <label for="edit_date">
                        <i class="fas fa-calendar"></i>
                        Date
                    </label>
                    <input type="date" id="edit_date" name="date" required>
                </div>
            </div>
            <div class="form-group">
                <label for="edit_category">
                    <i class="fas fa-tag"></i>
                    Category
                </label>
                <select id="edit_category" name="category" required>
                    <option value="">Select a category</option>
                    {% for cat in categories %}
                    <option value="{{ cat }}">{{ cat }}</option>
                    {% endfor %}
                </select>
            </div>
            <button type="submit" class="btn btn-primary btn-block">
                <i class="fas fa-save"></i>
                Save Changes
            </button>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Set default date to today
    document.getElementById('date').valueAsDate = new Date();

    // Modal functions
    function openModal(modalId) {
        document.getElementById(modalId).classList.add('active');
        document.body.style.overflow = 'hidden';
    }

    function closeModal(modalId) {
        document.getElementById(modalId).classList.remove('active');
        document.body.style.overflow = '';
    }

    function openEditModal(id, description, amount, category, date) {
        document.getElementById('editExpenseForm').action = `/edit_expense/${id}`;
        document.getElementById('edit_description').value = description;
        document.getElementById('edit_amount').value = amount;
        document.getElementById('edit_category').value = category;
        document.getElementById('edit_date').value = date;
        openModal('editExpenseModal');
    }

    // Close modal on outside click
    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.classList.remove('active');
                document.body.style.overflow = '';
            }
        });
    });

    // Chart data
    const monthlyData = {{ monthly_data | tojson }};
    const categoryData = {{ stats.by_category | tojson }};

    // Color palette
    const colors = {
        primary: '#6366f1',
        secondary: '#8b5cf6',
        accent: '#ec4899',
        success: '#10b981',
        warning: '#f59e0b',
        info: '#3b82f6'
    };

    const chartColors = [
        '#6366f1', '#8b5cf6', '#ec4899', '#10b981',
        '#f59e0b', '#3b82f6', '#ef4444', '#14b8a6',
        '#f97316', '#84cc16'
    ];

    // Monthly Chart
    const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
    new Chart(monthlyCtx, {
        type: 'bar',
        data: {
            labels: monthlyData.map(d => d.month),
            datasets: [{
                label: 'Spending',
                data: monthlyData.map(d => d.total),
                backgroundColor: 'rgba(99, 102, 241, 0.8)',
                borderColor: '#6366f1',
                borderWidth: 2,
                borderRadius: 8,
                borderSkipped: false,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    },
                    ticks: {
                        color: 'rgba(255, 255, 255, 0.7)',
                        callback: value => '$' + value
                    }
                },
                x: {
                    grid: {
                        display: false
                    },
                    ticks: {
                        color: 'rgba(255, 255, 255, 0.7)'
                    }
                }
            }
        }
    });

    // Category Chart
    const categoryCtx = document.getElementById('categoryChart').getContext('2d');
    new Chart(categoryCtx, {
        type: 'doughnut',
        data: {
            labels: categoryData.map(d => d.category),
            datasets: [{
                data: categoryData.map(d => d.total),
                backgroundColor: chartColors,
                borderWidth: 0,
                hoverOffset: 10
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        color: 'rgba(255, 255, 255, 0.8)',
                        padding: 15,
                        usePointStyle: true,
                        pointStyle: 'circle'
                    }
                }
            },
            cutout: '65%'
        }
    });

    // Add animation classes to table rows
    document.querySelectorAll('.expense-row').forEach((row, index) => {
        row.style.animationDelay = `${index * 0.05}s`;
    });
</script>
{% endblock %}